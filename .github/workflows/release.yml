name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build binaries
        run: |
          # Set version via ldflags
          VERSION=${{ steps.version.outputs.VERSION }}
          LDFLAGS="-s -w -X main.Version=${VERSION}"
          
          # Linux amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o build/rsyslog-rest-api-linux-amd64 .
          
          # Linux arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o build/rsyslog-rest-api-linux-arm64 .
          
          # Make executable
          chmod +x build/rsyslog-rest-api-*
      
      - name: Create offline package
        run: |
          # Create package directory
          mkdir -p package
          
          # Copy files
          cp build/rsyslog-rest-api-linux-amd64 package/rsyslog-rest-api
          cp .env.example package/
          cp rsyslog-rest-api.service package/
          cp LICENSE package/
          
          # Create README for package
          cat > package/README.md << 'PKGEOF'
          # rsyslog REST API - Offline Package
          
          ## Quick Install
          
          ```bash
          # 1. Run install script
          sudo ./install.sh
          
          # 2. Configure database credentials
          sudo nano /opt/rsyslog-rest-api/.env
          # Set: DB_HOST, DB_NAME, DB_USER, DB_PASS
          
          # 3. Set API key
          # Generate: openssl rand -hex 32
          sudo nano /opt/rsyslog-rest-api/.env
          # Set: API_KEY=your-generated-key
          
          # 4. Start
          sudo systemctl enable --now rsyslog-rest-api
          sudo systemctl status rsyslog-rest-api
          
          # 5. Test
          curl http://localhost:8000/health
          ```
          
          ## Documentation
          
          Full documentation: https://github.com/phil-bot/rsyslog-rest-api
          PKGEOF
          
          # Create install script
          cat > package/install.sh << 'INSTEOF'
          #!/bin/bash
          set -e
          
          echo "Installing rsyslog REST API..."
          
          # Check if running as root
          if [ "$EUID" -ne 0 ]; then 
            echo "Please run with sudo"
            exit 1
          fi
          
          INSTALL_DIR=/opt/rsyslog-rest-api
          
          # Create directory
          mkdir -p $INSTALL_DIR
          
          # Copy binary
          cp rsyslog-rest-api $INSTALL_DIR/
          chmod +x $INSTALL_DIR/rsyslog-rest-api
          
          # Copy config if not exists
          if [ ! -f $INSTALL_DIR/.env ]; then
            cp .env.example $INSTALL_DIR/.env
            echo "âœ“ Config file created: $INSTALL_DIR/.env"
          else
            echo "âœ“ Config file already exists (not overwritten)"
          fi
          
          # Copy systemd service
          cp rsyslog-rest-api.service /etc/systemd/system/
          systemctl daemon-reload
          
          echo ""
          echo "âœ“ Installation complete!"
          echo ""
          echo "IMPORTANT - Configuration required:"
          echo ""
          echo "  1. Set database credentials:"
          echo "     sudo nano $INSTALL_DIR/.env"
          echo "     Set: DB_HOST, DB_NAME, DB_USER, DB_PASS"
          echo ""
          echo "  2. Set API key (generate: openssl rand -hex 32):"
          echo "     sudo nano $INSTALL_DIR/.env"
          echo "     Set: API_KEY=your-generated-key"
          echo ""
          echo "  3. Secure config file:"
          echo "     sudo chmod 600 $INSTALL_DIR/.env"
          echo ""
          echo "  4. Start service:"
          echo "     sudo systemctl enable --now rsyslog-rest-api"
          echo ""
          echo "  5. Check status:"
          echo "     sudo systemctl status rsyslog-rest-api"
          echo ""
          echo "  6. Test API:"
          echo "     curl http://localhost:8000/health"
          echo ""
          INSTEOF
          
          chmod +x package/install.sh
          
          # Create tarball
          tar czf rsyslog-rest-api-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz package/
          
          echo "âœ“ Offline package created"
      
      - name: Generate checksums
        run: |
          cd build
          sha256sum rsyslog-rest-api-* > SHA256SUMS
          cd ..
          sha256sum rsyslog-rest-api-*.tar.gz >> build/SHA256SUMS
          cat build/SHA256SUMS
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/rsyslog-rest-api-linux-amd64
            build/rsyslog-rest-api-linux-arm64
            rsyslog-rest-api-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz
            build/SHA256SUMS
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## rsyslog REST API ${{ steps.version.outputs.VERSION }}
            
            High-performance REST API for rsyslog/MySQL written in Go.
            
            ### ðŸ“¦ Downloads
            
            **Recommended: Offline Package (includes installer)**
            - `rsyslog-rest-api-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz` - Complete package with install script
            
            **Standalone Binaries**
            - `rsyslog-rest-api-linux-amd64` - Linux x86_64
            - `rsyslog-rest-api-linux-arm64` - Linux ARM64
            
            ### ðŸš€ Quick Install (Offline Package)
            
            ```bash
            # Download
            wget https://github.com/phil-bot/rsyslog-rest-api/releases/download/${{ steps.version.outputs.VERSION }}/rsyslog-rest-api-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz
            
            # Extract
            tar xzf rsyslog-rest-api-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz
            cd package
            
            # Install
            sudo ./install.sh
            
            # Configure (REQUIRED!)
            sudo nano /opt/rsyslog-rest-api/.env
            # Set: DB_HOST, DB_NAME, DB_USER, DB_PASS, API_KEY
            
            # Secure config
            sudo chmod 600 /opt/rsyslog-rest-api/.env
            
            # Start
            sudo systemctl enable --now rsyslog-rest-api
            ```
            
            ### ðŸ”§ Standalone Binary
            
            ```bash
            # Download
            wget https://github.com/phil-bot/rsyslog-rest-api/releases/download/${{ steps.version.outputs.VERSION }}/rsyslog-rest-api-linux-amd64
            
            # Make executable
            chmod +x rsyslog-rest-api-linux-amd64
            
            # Run
            ./rsyslog-rest-api-linux-amd64
            ```
            
            ### âœ… Verify Checksums
            
            ```bash
            wget https://github.com/phil-bot/rsyslog-rest-api/releases/download/${{ steps.version.outputs.VERSION }}/SHA256SUMS
            sha256sum -c SHA256SUMS
            ```
            
            ### ðŸ“š Documentation
            
            Full documentation: https://github.com/phil-bot/rsyslog-rest-api
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
