name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ Node / Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          echo "âœ“ Frontend built ($(du -sh dist | cut -f1))"

      # â”€â”€ Redoc (offline API docs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Redoc standalone
        run: |
          curl -fsSL \
            https://cdn.jsdelivr.net/npm/redoc/bundles/redoc.standalone.js \
            -o docs/api-ui/redoc.standalone.js
          echo "âœ“ Redoc downloaded ($(du -sh docs/api-ui/redoc.standalone.js | cut -f1))"

      # â”€â”€ Go â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download Go modules
        run: go mod download

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          mkdir -p build
          LDFLAGS="-s -w -X main.Version=${VERSION}"

          echo "Building linux/amd64â€¦"
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags "${LDFLAGS}" -o build/rsyslox-linux-amd64 .

          echo "Building linux/arm64â€¦"
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -ldflags "${LDFLAGS}" -o build/rsyslox-linux-arm64 .

          chmod +x build/rsyslox-*
          ls -lh build/

      # â”€â”€ Offline package â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create offline package (amd64)
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          PKG=package
          mkdir -p $PKG

          # Binary
          cp build/rsyslox-linux-amd64 $PKG/rsyslox
          chmod +x $PKG/rsyslox

          # Systemd service
          cp rsyslox.service $PKG/

          # License
          cp LICENSE $PKG/ 2>/dev/null || true

          # Install script (generated from scripts/install.sh)
          cp scripts/install.sh $PKG/install.sh
          chmod +x $PKG/install.sh

          # Package README
          cat > $PKG/README.md << 'EOF'
          # rsyslox ${VERSION} â€” Offline Package

          ## Quick Install

          ```bash
          sudo ./install.sh
          ```

          The installer will:
          - Copy the binary to /opt/rsyslox/
          - Create the rsyslox system user
          - Install the systemd service
          - Open the setup wizard in your browser

          ## Full documentation

          https://github.com/phil-bot/rsyslox
          EOF

          # Create tarball
          TARBALL="rsyslox-${VERSION}-offline-linux-amd64.tar.gz"
          tar czf "$TARBALL" $PKG/
          echo "âœ“ Package created: $TARBALL ($(du -sh $TARBALL | cut -f1))"

      # â”€â”€ Checksums â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate SHA256 checksums
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          sha256sum \
            build/rsyslox-linux-amd64 \
            build/rsyslox-linux-arm64 \
            rsyslox-${VERSION}-offline-linux-amd64.tar.gz \
            > SHA256SUMS
          cat SHA256SUMS

      # â”€â”€ GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/rsyslox-linux-amd64
            build/rsyslox-linux-arm64
            rsyslox-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz
            SHA256SUMS
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          generate_release_notes: true
          body: |
            ## rsyslox ${{ steps.version.outputs.VERSION }}

            ### ðŸ“¦ Downloads

            | File | Description |
            |------|-------------|
            | `rsyslox-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz` | **Recommended** â€” complete package with install script |
            | `rsyslox-linux-amd64` | Standalone binary (Linux x86_64) |
            | `rsyslox-linux-arm64` | Standalone binary (Linux ARM64) |
            | `SHA256SUMS` | Checksums for verification |

            ### ðŸš€ Quick Install

            ```bash
            # Download offline package
            wget https://github.com/phil-bot/rsyslox/releases/download/${{ steps.version.outputs.VERSION }}/rsyslox-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz

            # Extract and install
            tar xzf rsyslox-${{ steps.version.outputs.VERSION }}-offline-linux-amd64.tar.gz
            cd package
            sudo ./install.sh
            ```

            The install script will guide you through initial setup via the web UI.

            ### âœ… Verify checksums

            ```bash
            wget https://github.com/phil-bot/rsyslox/releases/download/${{ steps.version.outputs.VERSION }}/SHA256SUMS
            sha256sum -c SHA256SUMS
            ```

            ### ðŸ“š Documentation

            https://github.com/phil-bot/rsyslox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
